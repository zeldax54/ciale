    {% extends 'gemaBundle::layout.html.twig' %}

    {% block gema_page -%}
    <h2>Listado de Toro</h2>

        <ul class="pager">
            <li class="next"><a href="#" id="toroCreate"><i class="fa fa-plus-circle"></i>
                    Nuevo Toro
                </a></li>
            <li class="next"><a href="#" id="toroCharge"><i class="fa fa-arrow-circle-up"></i>
                    Cargar toros desde Archivo
                </a></li>
        </ul>


    {% if entities is empty %}
    <div class="bs-callout bs-callout-info">
        <i class="fa fa-info-circle img-responsive info_icon"></i>
        <h4>Aviso</h4>
        <p>No existen registros de activos en la base de datos.</p>
    </div>
    {% else %}

    <div class="table-responsive">
        <table class="record_properties table table-hover table table-striped table-vmiddle" id="data-table-command" data-ajax="true" data-url="{{path('admin_toro_')}}" >
            <thead>
                <tr>

                    <th data-column-id="apodo">Apodo</th>
                    <th data-column-id="nombre">Nombre</th>
                    <th data-column-id="tiporaza" data-formatter="tiporaza">Tipo de Raza</th>
                    <th data-column-id="raza" data-formatter="raza">Raza</th>
                    <th data-column-id="publico" data-formatter="publico">Público</th>

                    <th colspan="3" data-formatter="commands">Editar/Eliminar/Publicar</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    {% endif %}
        <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Eliminar Registro</h4>
                    </div>
                    <div class="modal-body">
                        ¿Está seguro que desea eliminar el registro definitivamente? Esta accion no puede deshacerse.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary eliminarRegistro">Aceptar</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Crear Toro. Seleccione la Raza.</h4>
                    </div>
                    <div class="modal-body">
                        <select class="tag-select" id="razasselect">
                   {% for r in razas %}

                       <option value="{{ r.id }}">{{ r.nombre }}</option>
                        {% endfor %}
                            </select>
                    </div>
                    <div class="modal-footer">
                        <a type="button" class="btn btn-primary" id="crearToroSummit" href="#">Aceptar</a>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->




        {#Modal Upload file#}

        <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Cargar Toros </h4>
                    </div>
                    <div class="modal-body">

                            <form id="uploadForm" action="{{ path('gema_admin_uploadexcel') }}" method="post">
                                <label class="control-label"><strong>Raza</strong></label><br/>
                                <select class="tag-select" id="razasselect" name="razasselect">
                                    {% for r in razas %}

                                        <option value="{{ r.id }}">{{ r.nombre }}</option>

                                    {% endfor %}
                                </select>
                                <label class="control-label"><strong>Tabla Genetica Seleccionada</strong></label><br/>
                                <select class="tag-select" id="tablaSelected" name="tablaSelected">

                                </select>
                                <label>Archivo excel:</label><br/>
                                <dd id="torosFormAutoCargaExcel-element">
                                    <input class="form-control" name="torosFormAutoCargaExcel" id="torosFormAutoCargaExcel" accept=".xls,.xlsx" type="file" required>
                                    <p class="small">Extensión permitida: .xls o .xlsx</p></dd>
                                <dt class="control-label"><label class="optional">Actualizar datos de toros</label></dt>
                                <dd id="torosFormAutoCargaActualizarTorosExistentes-element">
                                    <label label class="label-primary"><input class="checkbox-inline" name="torosFormAutoCargaActualizarTorosExistentes"
                                                  id="torosFormAutoCargaActualizarTorosExistentes-1" value="0"
                                                  checked="checked" type="radio">Si, actualizar toros existentes y crear nuevos</label>
                                    <br><label class="label-primary"><input class="checkbox-inline" name="torosFormAutoCargaActualizarTorosExistentes" id="torosFormAutoCargaActualizarTorosExistentes-0" value="1" type="radio">No, solamente cargar toros nuevos</label></dd>
                                <br>


                                <dt id="torosFormAutoCargaTorosQueNoExisten-label"><label class="optional">Toros que no se encuentran en el archivo</label></dt>
                                <dd id="torosFormAutoCargaTorosQueNoExisten-element">
                                    <label class="label-primary"><input name="torosFormAutoCargaTorosQueNoExisten" id="torosFormAutoCargaTorosQueNoExisten-0" value="0" checked="checked" type="radio">Omitir, los toros que NO estén presentes no serán modificados</label><br>
                                    <label class="label-primary"><input name="torosFormAutoCargaTorosQueNoExisten" id="torosFormAutoCargaTorosQueNoExisten-2" value="1" type="radio">Desactivar, los toros que NO estén presentes en el archivo serán desactivados</label><br>
                                    <label class="label-primary"><input name="torosFormAutoCargaTorosQueNoExisten" id="torosFormAutoCargaTorosQueNoExisten-1" value="2" type="radio">Borrar, los toros que NO estén presentes en el archivo serán borrados</label>
                                    <p class="small">Que debe hacer el sistema con los toros que están cargados en el sistema pero que no están incluidos en el archivo enviado.</p></dd>
                                <input type="submit" class="btn btn-primary" id="updateToroSummit" value="Aceptar"><br>
                                <div style="text-align: center;margin: 0 auto" id="ce"><label id="targetLayer" class="small label-success"></label></div>

                            </form>

                    </div>
                    <div class="modal-footer">

                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    </div>

                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->



        <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width: 100% ">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Error</h4>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center;margin: 0 auto" id="errorcont"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        {% endblock %}

    {% block javascripts -%}
    {{ parent() }}
    <script>
        $(document).ready(function(){


        });

        $("#data-table-command").bootgrid({
            css: {
                icon: 'md icon',
                iconColumns: 'md-view-module',
                iconDown: 'md-expand-more',
                iconRefresh: 'md-refresh',
                iconUp: 'md-expand-less'
            },
            formatters: {
                "commands": function(column, row) {
                    var last="";
                    if(row.publico==1){
                       last= "<a   datapublic='1'  title='Publicar' style='background: #C9E2B1' data-id=\'" + row.id + "\' class=\"btn btn-icon command-edit publishbuttom\" ><span  class=\"md md-remove-red-eye\"></span></a>";
                    }
                    else{
                        last= "<a datapublic='0'  title='Publicar' style='background: indianred' data-id=\'" + row.id + "\' class=\"btn btn-icon command-edit publishbuttom\" ><span  class=\"md md-remove-red-eye\"></span></a>";
                    }
                    return "<a href='" + Routing.generate('admin_toro__edit', {id: row.id}) + "'  class=\"btn btn-icon command-edit\" ><span class=\"md md-edit\"></span></a> " +
                            "<a href='" + Routing.generate('admin_toro__delete', {id: row.id}) + "' data-id=\'" + row.id + "\' class=\"btn btn-icon command-delete\" ><span class=\"md md-delete\"></span></a>"+
                                    last;

                }
              ,
                "raza": function(column, row) {

                    return "" + row.raza.nombre;
                },
                "tiporaza": function(column, row) {

                    return "" + row.raza.tiporaza.tipo;
                },
                "publico": function(column, row) {
                  if(row.publico==1){
                      return '<span class="md md-turned-in"></span>';

                  }
                    return '<span class="md md-turned-in-not"></span>';
                }
            }, templates: {
                loading: "<tr><td colspan='9' class=\"loading\"><div class='loading'><img src='{{ asset('bundles/gema/images/loading.gif') }}' class='img-responsive'></div></td></tr>"
            }
        }).on("loaded.rs.jquery.bootgrid", function (e)
        {

            $(".command-delete").on('click', function (evt) {
                evt.preventDefault();
                url = Routing.generate('admin_toro__delete', {id: $(this).data('id')});
                $("#deleteModal").modal("show");
            });

            $(".eliminarRegistro").on("click", function (evt) {
                window.location = url;
            });

            $('.publishbuttom').on('click', function (evt) {
                var dataId=$(this).attr('data-id');
                var a=$(this);
                var dataPublish=$(this).attr('datapublic');
                var url = Routing.generate('gema_torocambpublic',{id:dataId});
                $.ajax({
                    type: 'GET',
                    url: url,
                    success: function (data) {
                  if(data[0]==1){

                      if(dataPublish==1){//Cambiar a no publico
                          console.log('NO Publico');
                          a.attr('style','background: indianred');
                          a.attr('datapublic',0);
                      }else{//A publico
                          console.log('Publico');
                          a.attr('style','background: #C9E2B1');
                          a.attr('datapublic',1);

                      }

                    }

                    },
                    error: function (req, stat, err) {
                       alert('error');
                        console.log(err);
                    }
                });
            });
        });


        $('#toroCreate').click(function(){

            $("#createModal").modal("show");
        });

        SetRazaURL($('#razasselect').val());
        DBConect('gema_raza_tablas',null,$('#razasselect').val(),'tablaSelected');



        function  SetRazaURL(razaid)
        {

          var ruta=Routing.generate('admin_toro__new', {idraza: razaid});
          $('#crearToroSummit').attr('href',ruta);
        }

        //Upload
        $('#toroCharge').click(function(){
            $("#uploadModal").modal("show");
        });

        $("#uploadForm").on('submit',(function(e){
            e.preventDefault();
            $('#targetLayer').empty();
            $.ajax({
                url: Routing.generate('gema_admin_uploadexcel'),
                type: "POST",
                data:  new FormData(this),
                contentType: false,
                cache: false,
                processData:false,
                success: function(data){
                    $("#targetLayer").html(data);
                },
                error: function(error,stat, err){
                  $("#errorcont").html(error.responseText);
                    $("#ce").html('<input type="button" class="btn btn-danger" value="Error cargando excel." id="seeerror">');

                }
            });
        }));
        $(document).on('click','#seeerror',function(){

            $('#uploadModal').modal('hide');
            $('#errorModal').modal('show');
        });

        $(document).on('change','#razasselect',function(){
            SetRazaURL($(this).val());
            DBConect('gema_raza_tablas',null,$(this).val(),'tablaSelected');
        });




    </script>
        <script>


            function updateFields()
            {
                SetRazaURL($('#razasselect').val());
                DBConect('gema_raza_tablas',null,$('#razasselect').val(),'tablaSelected');
            }
            $(document).ready(function(){
                updateFields();

            });

        </script>
    {% endblock %}

